<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HossAgent - Admin Console</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --border-subtle: #1f1f1f;
            --border-medium: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-tertiary: #666666;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --accent-orange: #f97316;
            --accent-blue: #3b82f6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg-primary); color: var(--text-primary); font-family: 'JetBrains Mono', monospace; padding: 2rem; line-height: 1.5; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid var(--border-medium); padding-bottom: 1.5rem; }
        h1 { font-size: 1.75rem; font-weight: 600; }
        .header-actions { display: flex; gap: 1rem; align-items: center; }
        .header-btn { background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-subtle); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; text-decoration: none; font-family: inherit; transition: all 0.2s; }
        .header-btn:hover { background: var(--bg-secondary); color: var(--text-primary); }
        .header-btn.portal { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .header-btn.logout { background: var(--accent-red); color: white; border-color: var(--accent-red); }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border-medium); }
        .tab { padding: 1rem 1.5rem; cursor: pointer; border: none; background: transparent; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; border-bottom: 2px solid transparent; transition: all 0.2s; font-size: 0.9rem; }
        .tab:hover { color: var(--text-primary); }
        .tab.active { color: var(--accent-green); border-bottom-color: var(--accent-green); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-subtle); }
        th { font-weight: 600; background: var(--bg-secondary); color: var(--accent-green); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; }
        tr:hover { background: var(--bg-secondary); }
        .status { font-weight: 500; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; }
        .status-active { color: var(--accent-green); background: rgba(34, 197, 94, 0.1); }
        .status-trial { color: var(--accent-orange); background: rgba(249, 115, 22, 0.1); }
        .status-cancelled { color: var(--accent-red); background: rgba(239, 68, 68, 0.1); }
        .status-open { color: var(--accent-blue); background: rgba(59, 130, 246, 0.1); }
        .status-in_progress { color: var(--accent-orange); background: rgba(249, 115, 22, 0.1); }
        .status-closed { color: var(--text-tertiary); background: rgba(102, 102, 102, 0.1); }
        .empty { text-align: center; padding: 2rem; color: var(--text-tertiary); }
        .loading { text-align: center; padding: 2rem; color: var(--text-tertiary); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .section-header h2 { font-size: 1.1rem; font-weight: 500; }
        .btn { padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-family: inherit; font-size: 0.8rem; border: none; transition: all 0.2s; }
        .btn-primary { background: var(--accent-green); color: var(--bg-primary); }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-subtle); }
        .btn-secondary:hover { background: var(--bg-secondary); color: var(--text-primary); }
        .btn-small { padding: 0.3rem 0.6rem; font-size: 0.75rem; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .kpi-card { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 1.25rem; }
        .kpi-value { font-size: 2rem; font-weight: 600; color: var(--accent-green); margin-bottom: 0.25rem; }
        .kpi-label { font-size: 0.75rem; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; }
        .kpi-change { font-size: 0.75rem; margin-top: 0.5rem; }
        .kpi-change.positive { color: var(--accent-green); }
        .kpi-change.negative { color: var(--accent-red); }
        .chart-container { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .chart-title { font-size: 0.9rem; font-weight: 500; margin-bottom: 1rem; color: var(--text-secondary); }
        .chart-wrapper { height: 300px; position: relative; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-secondary); border: 1px solid var(--border-medium); border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem; border-bottom: 1px solid var(--border-subtle); }
        .modal-header h3 { font-size: 1.1rem; font-weight: 600; color: var(--accent-green); }
        .modal-close { background: transparent; border: none; color: var(--text-tertiary); font-size: 1.5rem; cursor: pointer; }
        .modal-close:hover { color: var(--text-primary); }
        .modal-body { padding: 1.25rem; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 0.75rem; padding: 1.25rem; border-top: 1px solid var(--border-subtle); }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.4rem; text-transform: uppercase; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.75rem; background: var(--bg-tertiary); border: 1px solid var(--border-subtle); color: var(--text-primary); border-radius: 6px; font-family: inherit; font-size: 0.9rem; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-green); }
        .form-textarea { min-height: 150px; resize: vertical; }
        .detail-row { display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border-subtle); }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { color: var(--text-tertiary); font-size: 0.85rem; }
        .detail-value { color: var(--text-primary); font-size: 0.85rem; }
        .toggle-switch { position: relative; display: inline-flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .toggle-switch input { display: none; }
        .toggle-slider { width: 36px; height: 20px; background: var(--bg-tertiary); border: 1px solid var(--border-medium); border-radius: 20px; position: relative; transition: all 0.2s; }
        .toggle-slider::before { content: ''; position: absolute; width: 14px; height: 14px; background: var(--text-tertiary); border-radius: 50%; top: 2px; left: 2px; transition: all 0.2s; }
        .toggle-switch input:checked + .toggle-slider { background: var(--accent-green); border-color: var(--accent-green); }
        .toggle-switch input:checked + .toggle-slider::before { transform: translateX(16px); background: var(--bg-primary); }
        @media (max-width: 768px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .tabs { overflow-x: auto; }
            table { font-size: 0.85rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>HossAgent Admin</h1>
            <div class="header-actions">
                <span id="timezone-label" style="font-size: 0.7rem; color: var(--text-tertiary);"></span>
                <a href="/portal" class="header-btn portal">Portal</a>
                <a href="/admin/logout" class="header-btn logout">Logout</a>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('customers')">CUSTOMERS</button>
            <button class="tab" onclick="showTab('support')">SUPPORT INBOX</button>
            <button class="tab" onclick="showTab('analytics')">ANALYTICS</button>
        </div>

        <!-- CUSTOMERS TAB -->
        <div id="customers" class="tab-content active">
            <div class="section-header">
                <h2>Customer Accounts</h2>
                <button class="btn btn-secondary" onclick="loadCustomers()">Refresh</button>
            </div>
            <div id="customers-loading" class="loading">Loading customers...</div>
            <table id="customers-table" style="display: none;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Signup Date</th>
                        <th>Plan</th>
                        <th>Renewal</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="customers-body"></tbody>
            </table>
        </div>

        <!-- SUPPORT INBOX TAB -->
        <div id="support" class="tab-content">
            <div class="section-header">
                <h2>Support Tickets</h2>
                <button class="btn btn-secondary" onclick="loadTickets()">Refresh</button>
            </div>
            <div id="tickets-loading" class="loading">Loading tickets...</div>
            <table id="tickets-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Subject</th>
                        <th>Created</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tickets-body"></tbody>
            </table>
            <div id="tickets-empty" class="empty" style="display: none;">No support tickets</div>
        </div>

        <!-- ANALYTICS TAB -->
        <div id="analytics" class="tab-content">
            <div class="section-header">
                <h2>System Health Dashboard</h2>
                <button class="btn btn-secondary" onclick="loadAnalytics()">Refresh</button>
            </div>
            
            <div class="kpi-grid" id="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-customers">-</div>
                    <div class="kpi-label">Active Customers</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-signals">-</div>
                    <div class="kpi-label">Signals (7 days)</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-leads">-</div>
                    <div class="kpi-label">Leads Created (7 days)</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-enrichment-rate">-</div>
                    <div class="kpi-label">Enrichment Rate</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-outbound">-</div>
                    <div class="kpi-label">Emails Sent (7 days)</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-error-rate">-</div>
                    <div class="kpi-label">Error Rate</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Pipeline Flow (Last 7 Days)</div>
                <div class="chart-wrapper">
                    <canvas id="pipeline-chart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Daily Activity</div>
                <div class="chart-wrapper">
                    <canvas id="activity-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Detail Modal -->
    <div id="customer-modal" class="modal-overlay" onclick="if(event.target===this)closeCustomerModal()">
        <div class="modal">
            <div class="modal-header">
                <h3>Customer Details</h3>
                <button class="modal-close" onclick="closeCustomerModal()">&times;</button>
            </div>
            <div class="modal-body" id="customer-detail-body">
                <!-- Populated by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCustomerModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Ticket Detail Modal -->
    <div id="ticket-modal" class="modal-overlay" onclick="if(event.target===this)closeTicketModal()">
        <div class="modal">
            <div class="modal-header">
                <h3>Support Ticket</h3>
                <button class="modal-close" onclick="closeTicketModal()">&times;</button>
            </div>
            <div class="modal-body" id="ticket-detail-body">
                <!-- Populated by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTicketModal()">Close</button>
                <button class="btn btn-primary" id="save-ticket-btn" onclick="saveTicket()">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
    let pipelineChart = null;
    let activityChart = null;
    let currentTicketId = null;

    (function() {{
        const DEFAULT_TIMEZONE = 'America/New_York';
        try {{
            const detectedTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
            if (detectedTz) {{
                fetch('/api/save-timezone', {{
                    method: 'POST',
                    headers: {{ 'Content-Type': 'application/json' }},
                    body: JSON.stringify({{ timezone: detectedTz }})
                }}).catch(() => {{}});
                document.getElementById('timezone-label').textContent = 'Times: ' + detectedTz;
            }} else {{
                document.getElementById('timezone-label').textContent = 'Times: ' + DEFAULT_TIMEZONE + ' (default)';
            }}
        }} catch (e) {{
            document.getElementById('timezone-label').textContent = 'Times: ' + DEFAULT_TIMEZONE + ' (default)';
        }}
    }})();

    function showTab(tabId) {{
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`[onclick="showTab('${{tabId}}')"]`).classList.add('active');
        document.getElementById(tabId).classList.add('active');
        
        if (tabId === 'customers') loadCustomers();
        if (tabId === 'support') loadTickets();
        if (tabId === 'analytics') loadAnalytics();
    }}

    async function loadCustomers() {{
        const loading = document.getElementById('customers-loading');
        const table = document.getElementById('customers-table');
        const tbody = document.getElementById('customers-body');
        
        loading.style.display = 'block';
        table.style.display = 'none';
        
        try {{
            const res = await fetch('/api/admin/customers');
            const data = await res.json();
            
            tbody.innerHTML = '';
            data.customers.forEach(c => {{
                const statusClass = c.plan === 'paid' ? 'active' : (c.plan === 'trial' ? 'trial' : 'cancelled');
                const statusLabel = c.plan === 'paid' ? 'Active' : (c.plan === 'trial' ? 'Trial' : 'Cancelled');
                const renewal = c.renewal_date || '-';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${{c.id}}</td>
                        <td>${{c.contact_name || c.company}}</td>
                        <td>${{c.contact_email}}</td>
                        <td><span class="status status-${{statusClass}}">${{statusLabel}}</span></td>
                        <td>${{c.signup_date}}</td>
                        <td>${{c.plan}}</td>
                        <td>${{renewal}}</td>
                        <td>
                            <button class="btn btn-small btn-secondary" onclick="viewCustomer(${{c.id}})">Details</button>
                            <a href="/portal/${{c.public_token}}" class="btn btn-small btn-primary" target="_blank">View as Customer</a>
                        </td>
                    </tr>
                `;
            }});
            
            loading.style.display = 'none';
            table.style.display = 'table';
        }} catch (e) {{
            loading.textContent = 'Error loading customers';
        }}
    }}

    async function viewCustomer(id) {{
        try {{
            const res = await fetch(`/api/admin/customers/${{id}}`);
            const c = await res.json();
            
            const statusClass = c.plan === 'paid' ? 'active' : (c.plan === 'trial' ? 'trial' : 'cancelled');
            const statusLabel = c.plan === 'paid' ? 'Active' : (c.plan === 'trial' ? 'Trial' : 'Cancelled');
            
            document.getElementById('customer-detail-body').innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Customer ID</span>
                    <span class="detail-value">${{c.id}}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Company</span>
                    <span class="detail-value">${{c.company}}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Contact Name</span>
                    <span class="detail-value">${{c.contact_name || '-'}}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Email</span>
                    <span class="detail-value">${{c.contact_email}}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status</span>
                    <span class="detail-value"><span class="status status-${{statusClass}}">${{statusLabel}}</span></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Plan</span>
                    <span class="detail-value">${{c.plan}}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Subscription Status</span>
                    <span class="detail-value">${{c.subscription_status}}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Billing Method</span>
                    <span class="detail-value">${{c.billing_method || '-'}}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Signup Date</span>
                    <span class="detail-value">${{c.signup_date}}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Last Login</span>
                    <span class="detail-value">${{c.last_login || 'Never'}}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Renewal Date</span>
                    <span class="detail-value">${{c.renewal_date || '-'}}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Autopilot</span>
                    <span class="detail-value">
                        <label class="toggle-switch">
                            <input type="checkbox" id="autopilot-toggle-${{c.id}}" ${{c.autopilot_enabled ? 'checked' : ''}} onchange="toggleAutopilot(${{c.id}}, this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                        <span style="margin-left: 0.5rem; font-size: 0.8rem; color: var(--text-tertiary);">${{c.autopilot_enabled ? 'ON' : 'OFF'}}</span>
                    </span>
                </div>
                <div style="margin-top: 1.5rem; text-align: center;">
                    <a href="/portal/${{c.public_token}}" class="btn btn-primary" target="_blank">View as Customer</a>
                </div>
            `;
            
            document.getElementById('customer-modal').classList.add('active');
        }} catch (e) {{
            alert('Error loading customer details');
        }}
    }}

    async function toggleAutopilot(customerId, enabled) {{
        try {{
            await fetch(`/api/admin/customers/${{customerId}}/autopilot`, {{
                method: 'POST',
                headers: {{ 'Content-Type': 'application/json' }},
                body: JSON.stringify({{ enabled }})
            }});
        }} catch (e) {{
            alert('Error updating autopilot setting');
        }}
    }}

    function closeCustomerModal() {{
        document.getElementById('customer-modal').classList.remove('active');
    }}

    async function loadTickets() {{
        const loading = document.getElementById('tickets-loading');
        const table = document.getElementById('tickets-table');
        const empty = document.getElementById('tickets-empty');
        const tbody = document.getElementById('tickets-body');
        
        loading.style.display = 'block';
        table.style.display = 'none';
        empty.style.display = 'none';
        
        try {{
            const res = await fetch('/api/admin/support-tickets');
            const data = await res.json();
            
            if (data.tickets.length === 0) {{
                loading.style.display = 'none';
                empty.style.display = 'block';
                return;
            }}
            
            tbody.innerHTML = '';
            data.tickets.forEach(t => {{
                tbody.innerHTML += `
                    <tr>
                        <td>${{t.customer_name}}</td>
                        <td>${{t.subject}}</td>
                        <td>${{t.created_at}}</td>
                        <td><span class="status status-${{t.status}}">${{t.status.replace('_', ' ')}}</span></td>
                        <td>
                            <button class="btn btn-small btn-secondary" onclick="viewTicket(${{t.id}})">View</button>
                        </td>
                    </tr>
                `;
            }});
            
            loading.style.display = 'none';
            table.style.display = 'table';
        }} catch (e) {{
            loading.textContent = 'Error loading tickets';
        }}
    }}

    async function viewTicket(id) {{
        currentTicketId = id;
        try {{
            const res = await fetch(`/api/admin/support-tickets/${{id}}`);
            const t = await res.json();
            
            document.getElementById('ticket-detail-body').innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Customer</span>
                    <span class="detail-value">${{t.customer_name}} <a href="#" onclick="viewCustomer(${{t.customer_id}}); return false;" style="color: var(--accent-blue);">(view)</a></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Subject</span>
                    <span class="detail-value">${{t.subject}}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Created</span>
                    <span class="detail-value">${{t.created_at}}</span>
                </div>
                <div class="form-group">
                    <label class="form-label">Message</label>
                    <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 6px; white-space: pre-wrap;">${{t.body}}</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select id="ticket-status" class="form-select">
                        <option value="open" ${{t.status === 'open' ? 'selected' : ''}}>Open</option>
                        <option value="in_progress" ${{t.status === 'in_progress' ? 'selected' : ''}}>In Progress</option>
                        <option value="closed" ${{t.status === 'closed' ? 'selected' : ''}}>Closed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Internal Notes</label>
                    <textarea id="ticket-notes" class="form-textarea" placeholder="Add internal notes...">${{t.internal_notes || ''}}</textarea>
                </div>
            `;
            
            document.getElementById('ticket-modal').classList.add('active');
        }} catch (e) {{
            alert('Error loading ticket');
        }}
    }}

    async function saveTicket() {{
        if (!currentTicketId) return;
        
        const status = document.getElementById('ticket-status').value;
        const notes = document.getElementById('ticket-notes').value;
        
        try {{
            await fetch(`/api/admin/support-tickets/${{currentTicketId}}`, {{
                method: 'PUT',
                headers: {{ 'Content-Type': 'application/json' }},
                body: JSON.stringify({{ status, internal_notes: notes }})
            }});
            
            closeTicketModal();
            loadTickets();
        }} catch (e) {{
            alert('Error saving ticket');
        }}
    }}

    function closeTicketModal() {{
        document.getElementById('ticket-modal').classList.remove('active');
        currentTicketId = null;
    }}

    async function loadAnalytics() {{
        try {{
            const res = await fetch('/api/admin/analytics');
            const data = await res.json();
            
            document.getElementById('kpi-customers').textContent = data.active_customers;
            document.getElementById('kpi-signals').textContent = data.signals_7d.toLocaleString();
            document.getElementById('kpi-leads').textContent = data.leads_7d.toLocaleString();
            document.getElementById('kpi-enrichment-rate').textContent = data.enrichment_rate + '%';
            document.getElementById('kpi-outbound').textContent = data.outbound_7d.toLocaleString();
            document.getElementById('kpi-error-rate').textContent = data.error_rate + '%';
            
            renderPipelineChart(data.pipeline);
            renderActivityChart(data.daily_activity);
        }} catch (e) {{
            console.error('Error loading analytics:', e);
        }}
    }}

    function renderPipelineChart(pipeline) {{
        const ctx = document.getElementById('pipeline-chart').getContext('2d');
        
        if (pipelineChart) pipelineChart.destroy();
        
        pipelineChart = new Chart(ctx, {{
            type: 'bar',
            data: {{
                labels: ['Signals', 'Leads', 'Enriched', 'Outbound Sent'],
                datasets: [{{
                    data: [pipeline.signals, pipeline.leads, pipeline.enriched, pipeline.outbound],
                    backgroundColor: ['#3b82f6', '#f97316', '#22c55e', '#a855f7'],
                    borderRadius: 4
                }}]
            }},
            options: {{
                responsive: true,
                maintainAspectRatio: false,
                plugins: {{
                    legend: {{ display: false }}
                }},
                scales: {{
                    y: {{
                        beginAtZero: true,
                        grid: {{ color: '#1f1f1f' }},
                        ticks: {{ color: '#666666' }}
                    }},
                    x: {{
                        grid: {{ display: false }},
                        ticks: {{ color: '#a0a0a0' }}
                    }}
                }}
            }}
        }});
    }}

    function renderActivityChart(activity) {{
        const ctx = document.getElementById('activity-chart').getContext('2d');
        
        if (activityChart) activityChart.destroy();
        
        activityChart = new Chart(ctx, {{
            type: 'line',
            data: {{
                labels: activity.dates,
                datasets: [
                    {{
                        label: 'Signals',
                        data: activity.signals,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3
                    }},
                    {{
                        label: 'Leads',
                        data: activity.leads,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        fill: true,
                        tension: 0.3
                    }},
                    {{
                        label: 'Outbound',
                        data: activity.outbound,
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        fill: true,
                        tension: 0.3
                    }}
                ]
            }},
            options: {{
                responsive: true,
                maintainAspectRatio: false,
                plugins: {{
                    legend: {{
                        labels: {{ color: '#a0a0a0' }}
                    }}
                }},
                scales: {{
                    y: {{
                        beginAtZero: true,
                        grid: {{ color: '#1f1f1f' }},
                        ticks: {{ color: '#666666' }}
                    }},
                    x: {{
                        grid: {{ display: false }},
                        ticks: {{ color: '#a0a0a0' }}
                    }}
                }}
            }}
        }});
    }}

    document.addEventListener('DOMContentLoaded', () => {{
        loadCustomers();
    }});
    </script>
</body>
</html>
