<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HossAgent - Admin Console</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --border-subtle: #1f1f1f;
            --border-medium: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-tertiary: #666666;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --accent-orange: #f97316;
            --accent-blue: #3b82f6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg-primary); color: var(--text-primary); font-family: 'JetBrains Mono', monospace; padding: 2rem; line-height: 1.5; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid var(--border-medium); padding-bottom: 1.5rem; }
        h1 { font-size: 1.75rem; font-weight: 600; }
        .header-actions { display: flex; gap: 1rem; align-items: center; }
        .logout-btn { background: var(--accent-red); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; text-decoration: none; font-family: inherit; }
        .stats-bar { display: flex; gap: 2rem; margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-subtle); }
        .stat { display: flex; flex-direction: column; }
        .stat-value { font-size: 1.5rem; font-weight: 600; color: var(--accent-green); }
        .stat-label { font-size: 0.75rem; color: var(--text-tertiary); text-transform: uppercase; }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border-medium); }
        .tab { padding: 1rem; cursor: pointer; border: none; background: transparent; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab:hover { color: var(--text-primary); }
        .tab.active { color: var(--accent-green); border-bottom-color: var(--accent-green); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-subtle); }
        th { font-weight: 600; background: var(--bg-secondary); color: var(--accent-green); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; }
        tr:hover { background: var(--bg-secondary); }
        .status { font-weight: 500; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; }
        .sent, .active { color: var(--accent-green); background: rgba(34, 197, 94, 0.1); }
        .pending, .trial { color: var(--accent-orange); background: rgba(249, 115, 22, 0.1); }
        .error, .failed { color: var(--accent-red); background: rgba(239, 68, 68, 0.1); }
        .new { color: var(--accent-blue); background: rgba(59, 130, 246, 0.1); }
        .draft { color: var(--accent-orange); background: rgba(249, 115, 22, 0.1); }
        .empty { text-align: center; padding: 2rem; color: var(--text-tertiary); }
        .loading { text-align: center; padding: 2rem; }
        .score { display: inline-block; min-width: 40px; text-align: center; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; }
        .score-high { background: rgba(34, 197, 94, 0.2); color: var(--accent-green); }
        .score-medium { background: rgba(249, 115, 22, 0.2); color: var(--accent-orange); }
        .score-low { background: rgba(102, 102, 102, 0.2); color: var(--text-tertiary); }
        .truncate { max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .section-header h2 { font-size: 1.1rem; font-weight: 500; }
        .filter-input { padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border-subtle); color: var(--text-primary); border-radius: 6px; width: 250px; font-family: inherit; }
        .refresh-btn { background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-subtle); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-family: inherit; }
        .refresh-btn:hover { background: var(--bg-secondary); color: var(--text-primary); }
        .enrichment-filter-bar { display: flex; gap: 0.5rem; margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-subtle); flex-wrap: wrap; }
        .filter-tab { padding: 0.5rem 1rem; cursor: pointer; border: 1px solid var(--border-subtle); background: transparent; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; border-radius: 6px; transition: all 0.2s; font-size: 0.8rem; display: flex; align-items: center; gap: 0.5rem; }
        .filter-tab:hover { background: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-medium); }
        .filter-tab.active { background: var(--accent-green); color: var(--bg-primary); border-color: var(--accent-green); }
        .filter-tab .count { background: rgba(0,0,0,0.2); padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; }
        .filter-tab.active .count { background: rgba(0,0,0,0.3); }
        .enrichment-pill { font-weight: 500; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.02em; }
        .enrichment-unenriched { color: var(--accent-orange); background: rgba(249, 115, 22, 0.15); }
        .enrichment-with-domain { color: var(--accent-blue); background: rgba(59, 130, 246, 0.15); }
        .enrichment-with-phone { color: #a855f7; background: rgba(168, 85, 247, 0.15); }
        .enrichment-ready { color: var(--accent-green); background: rgba(34, 197, 94, 0.15); }
        .enrichment-sent { color: var(--text-primary); background: rgba(255, 255, 255, 0.15); }
        @media (max-width: 768px) {
            .stats-bar { flex-wrap: wrap; gap: 1rem; }
            .tabs { overflow-x: auto; }
            table { font-size: 0.85rem; }
            th, td { padding: 0.5rem; }
            .truncate { max-width: 150px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>HossAgent Admin</h1>
            <div class="header-actions">
                <span id="email-mode" style="font-size: 0.75rem; color: var(--text-tertiary);"></span>
                <a href="/admin/logout" class="logout-btn">Logout</a>
            </div>
        </div>

        <div class="stats-bar" id="stats-bar">
            <div class="stat">
                <span class="stat-value" id="stat-signals">-</span>
                <span class="stat-label">Signals Today</span>
            </div>
            <div class="stat">
                <span class="stat-value" id="stat-events">-</span>
                <span class="stat-label">LeadEvents</span>
            </div>
            <div class="stat">
                <span class="stat-value" id="stat-emails">-</span>
                <span class="stat-label">Emails Sent</span>
            </div>
            <div class="stat">
                <span class="stat-value" id="stat-customers">-</span>
                <span class="stat-label">Customers</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('signals')">SIGNALS</button>
            <button class="tab" onclick="showTab('leadevents')">LEAD EVENTS</button>
            <button class="tab" onclick="showTab('outbound')">OUTBOUND</button>
            <button class="tab" onclick="showTab('customers')">CUSTOMERS</button>
            <button class="tab" onclick="showTab('analytics')">ANALYTICS</button>
        </div>

        <!-- SIGNALS VIEW -->
        <div id="signals" class="tab-content active">
            <div class="section-header">
                <h2>Raw Signals from SignalNet</h2>
                <button class="refresh-btn" onclick="loadSignals()">Refresh</button>
            </div>
            <div id="signals-loading" class="loading">Loading signals...</div>
            <div id="signals-table" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Source</th>
                            <th>Geography</th>
                            <th>Score</th>
                            <th>Summary</th>
                            <th>Event Created</th>
                        </tr>
                    </thead>
                    <tbody id="signals-rows"></tbody>
                </table>
            </div>
        </div>

        <!-- LEAD EVENTS VIEW -->
        <div id="leadevents" class="tab-content">
            <div class="section-header">
                <h2>Converted Opportunities</h2>
                <button class="refresh-btn" onclick="loadLeadEvents()">Refresh</button>
            </div>
            <div class="enrichment-filter-bar" id="enrichment-filters">
                <button class="filter-tab active" data-status="" onclick="filterByEnrichmentStatus(this, '')">All <span class="count" id="count-all">-</span></button>
                <button class="filter-tab" data-status="UNENRICHED" onclick="filterByEnrichmentStatus(this, 'UNENRICHED')">Unenriched <span class="count" id="count-unenriched">-</span></button>
                <button class="filter-tab" data-status="WITH_DOMAIN_NO_EMAIL" onclick="filterByEnrichmentStatus(this, 'WITH_DOMAIN_NO_EMAIL')">With Domain <span class="count" id="count-with-domain">-</span></button>
                <button class="filter-tab" data-status="WITH_PHONE_ONLY" onclick="filterByEnrichmentStatus(this, 'WITH_PHONE_ONLY')">With Phone <span class="count" id="count-with-phone">-</span></button>
                <button class="filter-tab" data-status="ENRICHED_NO_OUTBOUND" onclick="filterByEnrichmentStatus(this, 'ENRICHED_NO_OUTBOUND')">Ready to Send <span class="count" id="count-ready">-</span></button>
                <button class="filter-tab" data-status="OUTBOUND_SENT" onclick="filterByEnrichmentStatus(this, 'OUTBOUND_SENT')">Outbound Sent <span class="count" id="count-sent">-</span></button>
            </div>
            <div id="leadevents-loading" class="loading">Loading lead events...</div>
            <div id="leadevents-table" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Customer</th>
                            <th>Lead Company</th>
                            <th>Lead Email</th>
                            <th>Lead Phone</th>
                            <th>Category</th>
                            <th>Score</th>
                            <th>Enrichment</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="leadevents-rows"></tbody>
                </table>
            </div>
        </div>

        <!-- OUTBOUND MESSAGES VIEW -->
        <div id="outbound" class="tab-content">
            <div class="section-header">
                <h2>Outbound Email Activity</h2>
                <button class="refresh-btn" onclick="loadOutbound()">Refresh</button>
            </div>
            <div id="outbound-loading" class="loading">Loading outbound messages...</div>
            <div id="outbound-table" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Customer</th>
                            <th>To</th>
                            <th>Subject</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="outbound-rows"></tbody>
                </table>
            </div>
        </div>

        <!-- CUSTOMERS VIEW -->
        <div id="customers" class="tab-content">
            <div class="section-header">
                <h2>Customer Accounts</h2>
                <button class="refresh-btn" onclick="loadCustomers()">Refresh</button>
            </div>
            <div id="customers-loading" class="loading">Loading customers...</div>
            <div id="customers-table" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th>Contact</th>
                            <th>Plan</th>
                            <th>Status</th>
                            <th>Autopilot</th>
                            <th>Mode</th>
                            <th>Tasks</th>
                            <th>Leads</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customers-rows"></tbody>
                </table>
            </div>
        </div>

        <!-- ANALYTICS VIEW -->
        <div id="analytics" class="tab-content">
            <div class="section-header">
                <h2>Traffic & Conversion Analytics</h2>
                <button class="refresh-btn" onclick="loadAnalytics()">Refresh</button>
            </div>
            <div id="analytics-loading" class="loading">Loading analytics...</div>
            <div id="analytics-content" style="display: none;">
                <div class="analytics-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <!-- Page Views Card -->
                    <div class="analytics-card" style="background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 1.5rem;">
                        <h3 style="font-size: 0.9rem; color: var(--text-tertiary); margin-bottom: 1rem; text-transform: uppercase;">Page Views (7d)</h3>
                        <div style="display: flex; gap: 2rem; margin-bottom: 1rem;">
                            <div>
                                <span id="analytics-total-views" style="font-size: 2rem; font-weight: 600; color: var(--accent-green);">-</span>
                                <div style="font-size: 0.75rem; color: var(--text-tertiary);">Total Views</div>
                            </div>
                            <div>
                                <span id="analytics-unique-visitors" style="font-size: 2rem; font-weight: 600; color: var(--accent-blue);">-</span>
                                <div style="font-size: 0.75rem; color: var(--text-tertiary);">Unique Visitors</div>
                            </div>
                        </div>
                        <div id="analytics-top-pages" style="font-size: 0.8rem; color: var(--text-secondary);"></div>
                    </div>

                    <!-- Funnel Card -->
                    <div class="analytics-card" style="background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 1.5rem;">
                        <h3 style="font-size: 0.9rem; color: var(--text-tertiary); margin-bottom: 1rem; text-transform: uppercase;">Signup Funnel (30d)</h3>
                        <div id="analytics-funnel" style="font-size: 0.85rem;"></div>
                    </div>

                    <!-- Checkout Card -->
                    <div class="analytics-card" style="background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 1.5rem;">
                        <h3 style="font-size: 0.9rem; color: var(--text-tertiary); margin-bottom: 1rem; text-transform: uppercase;">Checkout & Upgrades (30d)</h3>
                        <div id="analytics-checkout" style="font-size: 0.85rem;"></div>
                    </div>

                    <!-- Engagement Card -->
                    <div class="analytics-card" style="background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 1.5rem;">
                        <h3 style="font-size: 0.9rem; color: var(--text-tertiary); margin-bottom: 1rem; text-transform: uppercase;">Engagement (30d)</h3>
                        <div id="analytics-engagement" style="font-size: 0.85rem;"></div>
                    </div>
                </div>

                <!-- Top Referrers -->
                <div class="analytics-card" style="background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 0.9rem; color: var(--text-tertiary); margin-bottom: 1rem; text-transform: uppercase;">Top Traffic Sources (7d)</h3>
                    <div id="analytics-referrers" style="font-size: 0.85rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showTab(name) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(name).classList.add('active');
            event.target.classList.add('active');
            
            if (name === 'signals') loadSignals();
            else if (name === 'leadevents') {
                loadEnrichmentCounts();
                loadLeadEvents();
            }
            else if (name === 'outbound') loadOutbound();
            else if (name === 'customers') loadCustomers();
            else if (name === 'analytics') loadAnalytics();
        }

        function scoreClass(score) {
            if (score >= 70) return 'score-high';
            if (score >= 50) return 'score-medium';
            return 'score-low';
        }

        async function loadStats() {
            try {
                const resp = await fetch('/api/admin/stats');
                const data = await resp.json();
                document.getElementById('stat-signals').textContent = data.signals_today || 0;
                document.getElementById('stat-events').textContent = data.lead_events || 0;
                document.getElementById('stat-emails').textContent = data.emails_sent || 0;
                document.getElementById('stat-customers').textContent = data.customers || 0;
                document.getElementById('email-mode').textContent = data.email_mode || '';
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        async function loadSignals() {
            try {
                const resp = await fetch('/api/admin/signals');
                const data = await resp.json();
                
                if (!Array.isArray(data)) {
                    throw new Error(data.detail || data.error || 'Invalid response');
                }
                
                const rows = data.map(s => `
                    <tr>
                        <td>${new Date(s.created_at).toLocaleString()}</td>
                        <td>${s.source_type}</td>
                        <td>${s.geography || '-'}</td>
                        <td><span class="score ${scoreClass(s.score)}">${s.score}</span></td>
                        <td class="truncate" title="${s.summary}">${s.summary}</td>
                        <td>${s.event_created ? '<span class="status sent">Yes</span>' : '<span class="status" style="opacity:0.5">No</span>'}</td>
                    </tr>
                `).join('');
                
                document.getElementById('signals-rows').innerHTML = rows || '<tr><td colspan="6" class="empty">No signals yet</td></tr>';
                document.getElementById('signals-loading').style.display = 'none';
                document.getElementById('signals-table').style.display = 'block';
            } catch (e) {
                document.getElementById('signals-loading').innerHTML = 'Error: ' + e.message + ' <button onclick="loadSignals()" style="margin-left:10px;padding:5px 10px;cursor:pointer;">Retry</button>';
            }
        }

        let currentEnrichmentFilter = '';

        function getEnrichmentPillClass(status) {
            switch(status) {
                case 'UNENRICHED': return 'enrichment-unenriched';
                case 'WITH_DOMAIN_NO_EMAIL': return 'enrichment-with-domain';
                case 'WITH_PHONE_ONLY': return 'enrichment-with-phone';
                case 'ENRICHED_NO_OUTBOUND': return 'enrichment-ready';
                case 'OUTBOUND_SENT': return 'enrichment-sent';
                default: return 'enrichment-unenriched';
            }
        }

        function getEnrichmentLabel(status) {
            switch(status) {
                case 'UNENRICHED': return 'Unenriched';
                case 'WITH_DOMAIN_NO_EMAIL': return 'With Domain';
                case 'WITH_PHONE_ONLY': return 'With Phone';
                case 'ENRICHED_NO_OUTBOUND': return 'Ready';
                case 'OUTBOUND_SENT': return 'Sent';
                default: return status || 'Unenriched';
            }
        }
        
        function getPhoneTypeLabel(phoneType) {
            if (!phoneType) return '';
            switch(phoneType) {
                case 'mobile': return '<span style="color:var(--accent-green)">Mobile</span>';
                case 'landline': return '<span style="color:var(--accent-blue)">Landline</span>';
                case 'tollfree': return '<span style="color:var(--text-tertiary)">Toll-free</span>';
                default: return phoneType;
            }
        }

        async function loadEnrichmentCounts() {
            try {
                const resp = await fetch('/api/enrichment_status_counts');
                const data = await resp.json();
                
                document.getElementById('count-all').textContent = data.total || 0;
                document.getElementById('count-unenriched').textContent = data.counts?.UNENRICHED || 0;
                document.getElementById('count-with-domain').textContent = data.counts?.WITH_DOMAIN_NO_EMAIL || 0;
                document.getElementById('count-with-phone').textContent = data.counts?.WITH_PHONE_ONLY || 0;
                document.getElementById('count-ready').textContent = data.counts?.ENRICHED_NO_OUTBOUND || 0;
                document.getElementById('count-sent').textContent = data.counts?.OUTBOUND_SENT || 0;
            } catch (e) {
                console.error('Failed to load enrichment counts:', e);
            }
        }

        function filterByEnrichmentStatus(btn, status) {
            document.querySelectorAll('#enrichment-filters .filter-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            currentEnrichmentFilter = status;
            loadLeadEvents(status);
        }

        async function loadLeadEvents(enrichmentStatus) {
            const status = enrichmentStatus !== undefined ? enrichmentStatus : currentEnrichmentFilter;
            try {
                let url = '/api/lead_events_detailed';
                if (status) {
                    url += '?enrichment_status=' + encodeURIComponent(status);
                }
                const resp = await fetch(url);
                const data = await resp.json();
                
                if (!Array.isArray(data)) {
                    throw new Error(data.detail || data.error || 'Invalid response');
                }
                
                const rows = data.map(e => `
                    <tr>
                        <td>${e.created_at ? new Date(e.created_at).toLocaleString() : '-'}</td>
                        <td>${e.company || '-'}</td>
                        <td>${e.summary ? e.summary.substring(0, 40) + (e.summary.length > 40 ? '...' : '') : '-'}</td>
                        <td>${e.lead_email || '<span style="color:var(--text-tertiary)">-</span>'}</td>
                        <td>${e.lead_phone_e164 ? '<a href="tel:' + e.lead_phone_e164 + '" style="color:var(--accent-blue)">' + e.lead_phone_e164 + '</a> ' + getPhoneTypeLabel(e.phone_type) : '<span style="color:var(--text-tertiary)">-</span>'}</td>
                        <td>${e.category || '-'}</td>
                        <td><span class="score ${scoreClass(e.urgency_score)}">${e.urgency_score}</span></td>
                        <td><span class="enrichment-pill ${getEnrichmentPillClass(e.enrichment_status)}">${getEnrichmentLabel(e.enrichment_status)}</span></td>
                        <td><span class="status ${e.status.toLowerCase()}">${e.status}</span></td>
                    </tr>
                `).join('');
                
                document.getElementById('leadevents-rows').innerHTML = rows || '<tr><td colspan="9" class="empty">No lead events yet</td></tr>';
                document.getElementById('leadevents-loading').style.display = 'none';
                document.getElementById('leadevents-table').style.display = 'block';
            } catch (e) {
                document.getElementById('leadevents-loading').innerHTML = 'Error: ' + e.message + ' <button onclick="loadLeadEvents()" style="margin-left:10px;padding:5px 10px;cursor:pointer;">Retry</button>';
            }
        }

        async function loadOutbound() {
            try {
                const resp = await fetch('/api/admin/outbound-messages');
                const data = await resp.json();
                
                if (!Array.isArray(data)) {
                    throw new Error(data.detail || data.error || 'Invalid response');
                }
                
                const rows = data.map(m => `
                    <tr>
                        <td>${new Date(m.created_at).toLocaleString()}</td>
                        <td>${m.customer || '-'}</td>
                        <td>${m.to_email}</td>
                        <td class="truncate" title="${m.subject}">${m.subject}</td>
                        <td><span class="status ${m.status.toLowerCase()}">${m.status}</span></td>
                    </tr>
                `).join('');
                
                document.getElementById('outbound-rows').innerHTML = rows || '<tr><td colspan="5" class="empty">No outbound messages yet</td></tr>';
                document.getElementById('outbound-loading').style.display = 'none';
                document.getElementById('outbound-table').style.display = 'block';
            } catch (e) {
                document.getElementById('outbound-loading').innerHTML = 'Error: ' + e.message + ' <button onclick="loadOutbound()" style="margin-left:10px;padding:5px 10px;cursor:pointer;">Retry</button>';
            }
        }

        async function loadCustomers() {
            try {
                const resp = await fetch('/api/admin/customers-list');
                const data = await resp.json();
                
                if (!Array.isArray(data)) {
                    throw new Error(data.detail || data.error || 'Invalid response');
                }
                
                const rows = data.map(c => `
                    <tr>
                        <td>${c.company}</td>
                        <td>${c.contact_name}</td>
                        <td><span class="status ${c.plan === 'paid' ? 'active' : 'trial'}">${c.plan}</span></td>
                        <td><span class="status ${c.status.toLowerCase()}">${c.status}</span></td>
                        <td>${c.autopilot ? '<span style="color:var(--accent-green)">ON</span>' : '<span style="color:var(--text-tertiary)">OFF</span>'}</td>
                        <td>${c.outreach_mode || 'AUTO'}</td>
                        <td>${c.tasks_used}/${c.tasks_limit}</td>
                        <td>${c.leads_used}/${c.leads_limit}</td>
                        <td><a href="/portal/${c.public_token}" style="color: var(--accent-blue); text-decoration: none;">Portal</a></td>
                    </tr>
                `).join('');
                
                document.getElementById('customers-rows').innerHTML = rows || '<tr><td colspan="9" class="empty">No customers yet</td></tr>';
                document.getElementById('customers-loading').style.display = 'none';
                document.getElementById('customers-table').style.display = 'block';
            } catch (e) {
                document.getElementById('customers-loading').innerHTML = 'Error: ' + e.message + ' <button onclick="loadCustomers()" style="margin-left:10px;padding:5px 10px;cursor:pointer;">Retry</button>';
            }
        }

        async function loadAnalytics() {
            try {
                const resp = await fetch('/api/admin/analytics');
                const data = await resp.json();
                
                if (data.detail) {
                    throw new Error(data.detail);
                }
                
                const pv = data.page_views_7d || {};
                const funnel = data.funnel_30d?.funnel || {};
                const engagement = data.funnel_30d?.engagement || {};
                const referrers = pv.top_referrers || {};
                const byPage = pv.by_page || {};
                
                document.getElementById('analytics-total-views').textContent = pv.total_views || 0;
                document.getElementById('analytics-unique-visitors').textContent = pv.unique_visitors || 0;
                
                const topPages = Object.entries(byPage).slice(0, 5).map(([page, count]) => 
                    `<div style="display:flex;justify-content:space-between;padding:0.25rem 0;border-bottom:1px solid var(--border-subtle);">
                        <span>${page}</span><span style="color:var(--accent-green)">${count}</span>
                    </div>`
                ).join('') || '<span style="color:var(--text-tertiary)">No page views yet</span>';
                document.getElementById('analytics-top-pages').innerHTML = topPages;
                
                const signupRate = funnel.signup_conversion_rate || 0;
                document.getElementById('analytics-funnel').innerHTML = `
                    <div style="display:grid;gap:0.5rem;">
                        <div style="display:flex;justify-content:space-between;">
                            <span>Signup Started</span><span style="color:var(--accent-orange)">${funnel.signup_started || 0}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;">
                            <span>Signup Completed</span><span style="color:var(--accent-green)">${funnel.signup_completed || 0}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;">
                            <span>Signup Abandoned</span><span style="color:var(--accent-red)">${funnel.signup_abandoned || 0}</span>
                        </div>
                        <div style="margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid var(--border-subtle);display:flex;justify-content:space-between;">
                            <span>Conversion Rate</span><span style="color:${signupRate >= 50 ? 'var(--accent-green)' : signupRate >= 25 ? 'var(--accent-orange)' : 'var(--accent-red)'}">${signupRate}%</span>
                        </div>
                    </div>
                `;
                
                const checkoutRate = funnel.checkout_conversion_rate || 0;
                document.getElementById('analytics-checkout').innerHTML = `
                    <div style="display:grid;gap:0.5rem;">
                        <div style="display:flex;justify-content:space-between;">
                            <span>Checkout Started</span><span style="color:var(--accent-orange)">${funnel.checkout_started || 0}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;">
                            <span>Checkout Completed</span><span style="color:var(--accent-green)">${funnel.checkout_completed || 0}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;">
                            <span>Checkout Abandoned</span><span style="color:var(--accent-red)">${funnel.checkout_abandoned || 0}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;">
                            <span>Upgrades</span><span style="color:var(--accent-green)">${funnel.upgrades || 0}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;">
                            <span>Cancellations</span><span style="color:var(--accent-red)">${funnel.cancellations || 0}</span>
                        </div>
                    </div>
                `;
                
                document.getElementById('analytics-engagement').innerHTML = `
                    <div style="display:grid;gap:0.5rem;">
                        <div style="display:flex;justify-content:space-between;">
                            <span>Logins</span><span style="color:var(--accent-blue)">${engagement.logins || 0}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;">
                            <span>Portal Views</span><span style="color:var(--accent-blue)">${engagement.portal_views || 0}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;">
                            <span>Active Customers</span><span style="color:var(--accent-green)">${engagement.unique_active_customers || 0}</span>
                        </div>
                    </div>
                `;
                
                const referrerList = Object.entries(referrers).slice(0, 10).map(([domain, count]) => 
                    `<div style="display:flex;justify-content:space-between;padding:0.25rem 0;border-bottom:1px solid var(--border-subtle);">
                        <span>${domain}</span><span style="color:var(--accent-blue)">${count}</span>
                    </div>`
                ).join('') || '<span style="color:var(--text-tertiary)">No referrer data yet</span>';
                document.getElementById('analytics-referrers').innerHTML = referrerList;
                
                document.getElementById('analytics-loading').style.display = 'none';
                document.getElementById('analytics-content').style.display = 'block';
            } catch (e) {
                document.getElementById('analytics-loading').innerHTML = 'Error: ' + e.message + ' <button onclick="loadAnalytics()" style="margin-left:10px;padding:5px 10px;cursor:pointer;">Retry</button>';
            }
        }

        window.addEventListener('load', () => {
            loadStats();
            loadSignals();
        });
    </script>
</body>
</html>
