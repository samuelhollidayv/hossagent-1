Got you. Here‚Äôs the all-in-one MagicBox superprompt you can paste straight into Agent. I‚Äôve folded in:
	‚Ä¢	Miami env stuff
	‚Ä¢	Customer portal tweaks (subscription card, reports, usage counters, cancel)
	‚Ä¢	Login persistence + forgot password
	‚Ä¢	Stripe assumptions / DRY_RUN
	‚Ä¢	Admin Console simplification (Signals ‚Üí LeadEvents ‚Üí Outputs)

‚∏ª

üîß HossAgent Superprompt (Admin + Portal Consolidation)

You are working on my HossAgent app in Replit.
Treat this as a refactor + UX pass, not a rewrite.
Do not delete working features such as login, signup, trial logic, Stripe wiring, or the Signals/LeadEvent models.
Instead, consolidate and polish them.

‚∏ª

0. High-level product context

HossAgent is an autonomous AI BizDev system with:
	‚Ä¢	Landing page (/)
	‚Ä¢	Customer portal (/portal)
	‚Ä¢	Login/signup
	‚Ä¢	Admin ‚ÄúOperator Console‚Äù (/admin)
	‚Ä¢	Signals + LeadEvent engine for opportunities
	‚Ä¢	Stripe subscription model (single $99/mo plan)
	‚Ä¢	DRY_RUN email mode (for now)

Environment variables (already present in Secrets):
	‚Ä¢	OPENAI_API_KEY
	‚Ä¢	ENABLE_STRIPE
	‚Ä¢	STRIPE_API_KEY (secret)
	‚Ä¢	STRIPE_PUBLIC_KEY
	‚Ä¢	STRIPE_WEBHOOK_SECRET
	‚Ä¢	SESSION_SECRET
	‚Ä¢	ADMIN_PASSWORD
	‚Ä¢	EMAIL_MODE (e.g. DRY_RUN)
	‚Ä¢	LEAD_NICHE
	‚Ä¢	LEAD_GEOGRAPHY

We‚Äôre currently biased to Miami / Broward and SMB niches via those env vars.

‚∏ª

1. Customer Portal UX ( /portal )

1.1 Subscription card placement

In the portal templates:
	‚Ä¢	Move the subscription status card (plan name, $/month, trial days remaining, tasks used, leads used, ‚ÄúStart Paid Subscription‚Äù button) to the top of the page, directly under the main heading.
	‚Ä¢	Below that, show operational sections such as:
	‚Ä¢	Today‚Äôs Opportunities / Lead Events
	‚Ä¢	Reports / Recent Work
	‚Ä¢	Task history (if we keep it)
	‚Ä¢	Keep styling consistent with current dark theme.

1.2 Usage counters wired to Signals/LeadEvents

Currently, ‚ÄúTasks used‚Äù and ‚ÄúLeads used‚Äù don‚Äôt line up with the new Signals/LeadEvent engine.

Implement:
	‚Ä¢	When we create a LeadEvent for a customer, increment that customer‚Äôs leads_used.
	‚Ä¢	When we execute a meaningful agent task for a customer (e.g. generating a research/report output tied to a LeadEvent, or running a substantial analysis), increment tasks_used.

Ensure:
	‚Ä¢	These counters show in the portal and in the admin console off the same data.
	‚Ä¢	For now, treat limits as soft caps:
	‚Ä¢	Do not hard-block usage.
	‚Ä¢	Keep limits visible (e.g. ‚Äú0 / 15 tasks‚Äù) but let trials continue to use the system.
	‚Ä¢	If there‚Äôs existing code that blocks based on limits, relax it so trials aren‚Äôt blocked.

1.3 Reports / ‚ÄúRecent Work‚Äù surface

We need the portal to show actual output, not just stubs.
	‚Ä¢	Ensure we have a Report (or equivalent) model in the DB for Ops outputs. If missing, create it with fields something like:
	‚Ä¢	id
	‚Ä¢	customer_id
	‚Ä¢	lead_event_id (nullable if general)
	‚Ä¢	title
	‚Ä¢	summary
	‚Ä¢	content (full HTML/markdown or blob)
	‚Ä¢	created_at
	‚Ä¢	For every research run / market analysis / report, persist a Report row.

Portal:
	‚Ä¢	Add a Reports or Recent Work section that lists:
	‚Ä¢	Date
	‚Ä¢	Title
	‚Ä¢	Short summary
	‚Ä¢	Each report should be viewable:
	‚Ä¢	Either as a dedicated /portal/report/<id> page, or an expandable panel/modal.
	‚Ä¢	If we‚Äôre already emailing reports, keep that behavior, but treat the portal as source of truth:
	‚Ä¢	Email = notification only.
	‚Ä¢	Portal = canonical record.

1.4 Opportunities & Tasks clarity

Right now, customers see multiple similar tables; we need clarity:
	‚Ä¢	In the portal, show one main table for Lead Events / Opportunities derived from the LeadEvent model:
	‚Ä¢	columns: summary, category, urgency, status (NEW / CONTACTED / RESPONDED), timestamp.
	‚Ä¢	Make each row clickable:
	‚Ä¢	Show a detail view with:
	‚Ä¢	Supporting signal context
	‚Ä¢	Any associated outbound messages
	‚Ä¢	Any associated report(s)
	‚Ä¢	Task history:
	‚Ä¢	Either fold task history into the Reports section (if tasks essentially produce reports),
	‚Ä¢	Or keep a Task History table but ensure each item links to the underlying report/output or LeadEvent so it‚Äôs not just a dead stub.

No orphan tables: every row a customer can see should either do something (view detail) or clearly indicate what it represents.

1.5 Cancellation (MVP)

For paid accounts (plan active, not just trial):
	‚Ä¢	Show a ‚ÄúCancel subscription‚Äù button in the subscription card.
	‚Ä¢	When clicked:
	‚Ä¢	Set a flag on the subscription record like cancelled_at_period_end = True (or equivalent).
	‚Ä¢	Show copy:
‚ÄúYour subscription will remain active until the end of the current billing period. You won‚Äôt be charged again.‚Äù
	‚Ä¢	For now, do NOT call Stripe APIs to cancel. This is a backend-only state flag we‚Äôll later wire into Stripe.

Admin console should retain full power to:
	‚Ä¢	Reactivate customers
	‚Ä¢	Override / comp accounts

‚∏ª

2. Authentication & Sessions

2.1 Session persistence

Improve auth so normal users don‚Äôt have to log in constantly:
	‚Ä¢	Use secure, HTTP-only cookies with a reasonable expiry (e.g. 14 days).
	‚Ä¢	As long as the session cookie is valid:
	‚Ä¢	/portal should load without re-login.
	‚Ä¢	Include a Log out link/button that:
	‚Ä¢	Clears the session.
	‚Ä¢	Redirects back to login or landing page.

We don‚Äôt need a ‚Äúremember me‚Äù checkbox yet ‚Äî just set session expiry to something user-friendly.

Ensure this works in both local/preview and published environments.

2.2 Forgot password flow

Implement a basic password reset:
	‚Ä¢	Add ‚ÄúForgot your password?‚Äù link on the login page.
	‚Ä¢	Flow:
	1.	User enters their email.
	2.	Generate a secure, time-limited token (e.g. random string with expiry).
	3.	Store it in the DB, associated with that user.
	4.	Send an email with a reset link like /reset-password?token=....
	‚Ä¢	In DRY_RUN email mode, log the reset link to console/logs so I can see it.
	5.	Build /reset-password route:
	‚Ä¢	Validates token & expiry.
	‚Ä¢	Lets user set new password (with basic requirements).
	‚Ä¢	Consumes token (one-time use).
	‚Ä¢	Logs user in and redirects to /portal.

Handle error states clearly:
	‚Ä¢	Invalid/expired token
	‚Ä¢	Email not found (respond generically, don‚Äôt leak existence of accounts)

‚∏ª

3. Stripe / Billing Assumptions
	‚Ä¢	ENABLE_STRIPE and the Stripe keys are already in Secrets.
	‚Ä¢	For now:
	‚Ä¢	Use Stripe primarily to:
	‚Ä¢	Create checkout links
	‚Ä¢	Handle ‚Äúreal‚Äù billing when we flip from DRY_RUN.
	‚Ä¢	Admin ‚ÄúUpgrade‚Äù override should not require Stripe checkout (see section 4).

We are okay if billing portal or advanced Stripe features are stubbed or disabled, as long as:
	‚Ä¢	Trial creation works.
	‚Ä¢	Upgrade via admin override works.
	‚Ä¢	Portal copy behaves correctly based on plan/trial status.

‚∏ª

4. Admin Console (‚ÄúHoss Control Room‚Äù) Consolidation

Goal: collapse the junk drawer into 1‚Äì3 coherent panels that align with the new architecture:

Signals ‚Üí LeadEvents ‚Üí Outputs

4.1 Remove / deprecate noisy panels

Remove or hide from UI these legacy sections, unless they are still absolutely required by code:
	‚Ä¢	Auto-created Leads / seed leads
	‚Ä¢	Recent Leads (legacy)
	‚Ä¢	Lead Source test/configuration panel
	‚Ä¢	Email Health summary panel
	‚Ä¢	Draft Invoices (no longer relevant with new pricing approach)
	‚Ä¢	‚ÄúBizDev Templates‚Äù configuration block (move to a Settings/config view later if needed)
	‚Ä¢	‚ÄúRecent Generated Emails‚Äù panel (fold into Outbound history)
	‚Ä¢	Standalone ‚ÄúPending Outreach‚Äù panel (fold into Outbound list)
	‚Ä¢	Any duplicate ‚ÄúTask history‚Äù that doesn‚Äôt link to real outputs

Important:
If any of these are tightly coupled in the backend, refactor carefully rather than deleting core logic.
The goal is to simplify the UI, not to break data flows.

4.2 Core panels we do want

4.2.1 KPI bar at top
Add a row of simple KPIs at the top of /admin:
	‚Ä¢	Signals Today
	‚Ä¢	New Lead Events Today
	‚Ä¢	Outbound Sent Today
	‚Ä¢	Reports Delivered Today
	‚Ä¢	Errors / Failed Outbound (if easy to compute)

Purely read-only; no need for perfect accuracy in v1, just reasonable queries.

4.2.2 Signals Table (raw)
Keep a collapsible Signals section:
	‚Ä¢	Columns:
	‚Ä¢	summary (shortened)
	‚Ä¢	category
	‚Ä¢	geography/location (if present)
	‚Ä¢	created_at
	‚Ä¢	lead_event_id (if mapped)
	‚Ä¢	This is for debugging and ‚Äúwhat is the system seeing?‚Äù

4.2.3 Lead Events Table (primary source of truth)
The main admin workhorse:
	‚Ä¢	One table backed purely by the LeadEvent model.
	‚Ä¢	Columns:
	‚Ä¢	summary
	‚Ä¢	category (REPUTATION_CHANGE / COMPETITOR_SHIFT / OPPORTUNITY / etc.)
	‚Ä¢	urgency score
	‚Ä¢	status (NEW / CONTACTED / RESPONDED / FAILED)
	‚Ä¢	has_outbound? (boolean indicator)
	‚Ä¢	has_report? (boolean indicator)
	‚Ä¢	created_at
	‚Ä¢	company/customer

Row click / expand:
	‚Ä¢	Show:
	‚Ä¢	Underlying signal(s)
	‚Ä¢	Outbound messages generated (if any)
	‚Ä¢	Associated report(s)
	‚Ä¢	Any errors

This table replaces legacy ‚ÄúRecent Leads‚Äù, ‚ÄúPending Outreach‚Äù, etc.

4.2.4 Output History (Outbound + Reports)
One combined ‚ÄúOutputs‚Äù section with filters:
	‚Ä¢	Outbound messages
	‚Ä¢	lead_event_id
	‚Ä¢	to_email
	‚Ä¢	subject
	‚Ä¢	status (sent, failed, pending, dry_run)
	‚Ä¢	timestamp
	‚Ä¢	Reports / Tasks
	‚Ä¢	report_title
	‚Ä¢	linked lead_event_id
	‚Ä¢	status
	‚Ä¢	timestamp
	‚Ä¢	view link to open report

Filtering:
	‚Ä¢	Allow filter by customer, by date range, and by type (Outbound vs Reports) if feasible.

This becomes the canonical ‚ÄúWhat has Hoss actually done?‚Äù view.

4.3 Admin ‚ÄúUpgrade‚Äù button

Fix the Upgrade button behavior in the admin customer plans section:
	‚Ä¢	When clicked on a trial customer:
	‚Ä¢	Mark subscription as paid/active with unlimited tasks/leads.
	‚Ä¢	Update subscription record fields, e.g.:
	‚Ä¢	status = "ACTIVE"
	‚Ä¢	plan = "PRO"
	‚Ä¢	billing_method = "ADMIN_OVERRIDE"
	‚Ä¢	clear trial_end or trial_days_left
	‚Ä¢	set tasks_limit / leads_limit to something like None or ‚Äúunlimited‚Äù
	‚Ä¢	After upgrade:
	‚Ä¢	Portal should show plan as active, no trial countdown.
	‚Ä¢	Do not require Stripe checkout for admin upgrades right now.

4.4 Operator Console ingress

Currently, ‚ÄúOperator Console‚Äù link is in the footer and easy to miss.
	‚Ä¢	Keep /admin protected behind ADMIN_PASSWORD as before.
	‚Ä¢	Ensure there is a clear, consistent link to the admin console:
	‚Ä¢	Either in footer but visually stronger,
	‚Ä¢	Or behind some keyboard-only link if you prefer stealth.
	‚Ä¢	Do not expose it as a big obvious button to customers; this is for me as operator.

‚∏ª

5. Miami Bias (Environment usage)

Confirm that:
	‚Ä¢	LEAD_GEOGRAPHY and LEAD_NICHE are used in the Signals/LeadEvent engine as default filters/weights.
	‚Ä¢	We are biasing:
	‚Ä¢	Geography to Miami/Broward/South Florida
	‚Ä¢	Niches to things like med spas, HVAC, roofers, etc.
	‚Ä¢	Do not change the values themselves; just ensure they flow cleanly:
	‚Ä¢	e.g., Signals agent reads them
	‚Ä¢	LeadEvent creation uses them for scoring/selection

Add comments in the relevant files to make this behavior obvious (e.g. ‚ÄúMiami-first targeting via LEAD_GEOGRAPHY, LEAD_NICHE‚Äù).

‚∏ª

6. QA Checklist (what you must manually verify)

After implementing:
	1.	Run the app in preview.
	2.	Create a brand new test customer via signup.
	3.	Log in to /portal:
	‚Ä¢	Subscription card is at the top.
	‚Ä¢	Usage counters visible and non-erroring (even if 0).
	4.	Trigger some LeadEvents and a sample report:
	‚Ä¢	leads_used increments when new LeadEvents are created.
	‚Ä¢	tasks_used increments when a report/major task runs.
	‚Ä¢	Reports appear in the Reports/Recent Work section and are viewable.
	5.	Admin console:
	‚Ä¢	KPI bar visible.
	‚Ä¢	Signals table populated.
	‚Ä¢	Lead Events table shows meaningful rows with status and flags.
	‚Ä¢	Outputs section shows outbound emails + reports.
	6.	Upgrade test:
	‚Ä¢	In admin, click Upgrade on the new customer.
	‚Ä¢	Portal reflects paid plan, no trial countdown; unlimited caps.
	7.	Auth:
	‚Ä¢	Log in, browse around, reload browser tab:
	‚Ä¢	Session persists (no repeated login prompts within a reasonable time).
	‚Ä¢	Log out link works and clears session.
	8.	Forgot password:
	‚Ä¢	Request reset.
	‚Ä¢	In DRY_RUN mode, confirm reset link appears in logs/console.
	‚Ä¢	Visit link, reset password, and confirm you can log in with new password.
	9.	Cancel button:
	‚Ä¢	For a paid account, click ‚ÄúCancel subscription‚Äù.
	‚Ä¢	DB shows cancellation flag set.
	‚Ä¢	Portal copy changes to reflect ‚Äúwill not be charged again‚Äù.
	10.	Miami env:

	‚Ä¢	Confirm in code that Signals/LeadEvent logic reads LEAD_GEOGRAPHY + LEAD_NICHE.

Please add inline comments for any assumptions or TODOs, especially around:
	‚Ä¢	Where Report data is stored and rendered
	‚Ä¢	Any remaining limitations in billing/Stripe behavior
	‚Ä¢	Any parts where legacy tables still exist for backwards compatibility

Do not introduce new external dependencies unless absolutely necessary.

‚∏ª

That‚Äôs it.