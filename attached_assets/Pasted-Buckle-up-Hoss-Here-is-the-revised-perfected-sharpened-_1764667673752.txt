Buckle up, Hoss.
Here is the revised, perfected, sharpened-to-a-razor Master Prompt ‚Äî incorporating every safeguard, guardrail, enhancement, and anti-disaster clause from your notes and mine.

This is the version you paste verbatim into the Replit Magic Bucket.

No commentary.
No fences.
No apologies.
Just the One Prompt To Rule Them All‚Ñ¢.

============================================================
üö® THE SUPERPROMPT ‚Äî FINAL CUT (COPY/PASTE INTO REPLIT AGENT EXACTLY AS IS)

Replit Agent ‚Äî I‚Äôm ready for the next major upgrade of HossAgent. The system already runs autonomously with lead generation, BizDev outreach, onboarding, ops execution, and billing. Now implement the next 5 features to move this from MVP to revenue-producing autonomy:

I need you to deliver ALL of the following without breaking any existing behavior:

A) Full production outbound emailing (SENDGRID + SMTP) with robust DRY_RUN fallback
B) Real lead ingestion via external Lead Search API
C) Niche-tuned BizDev template engine
D) Stripe billing integration (payment links + webhook)
E) Customer Portal 2.0 (read-only MVP for clients)

You MUST:

‚Ä¢ Inspect the whole codebase (models.py, agents.py, email_utils.py, lead_sources.py, lead_service.py, main.py, database.py, templates/*, replit.md)
‚Ä¢ Add these subsystems modularly, safely, and without regression
‚Ä¢ Preserve DRY_RUN mode as the default and iron law of the system
‚Ä¢ Use environment variables ONLY ‚Äî never hardcode configuration
‚Ä¢ Auto-migrate DB schema if needed
‚Ä¢ Add logging across all new behavior
‚Ä¢ Update admin console in the existing noir minimal style
‚Ä¢ Ensure autopilot loop NEVER crashes due to config issues
‚Ä¢ Provide a final summary of all file changes, required env vars, and test steps

============================================================
A) REAL OUTBOUND EMAIL SYSTEM (SENDGRID + SMTP + DRY_RUN)
	1.	In email_utils.py, expand to include:

‚Ä¢ DRY_RUN mode (must ALWAYS work, even if everything else fails)
‚Ä¢ SENDGRID sending (via API)
‚Ä¢ SMTP sending (TLS)
‚Ä¢ Unified send_email(‚Ä¶) entrypoint
‚Ä¢ Central config loader for EMAIL_MODE with automatic fallback:
	‚Ä¢	If ANY required variable for SENDGRID or SMTP is missing/invalid ‚Üí fall back to DRY_RUN
	‚Ä¢	Log: [DRY_RUN_FALLBACK] <reason>

‚Ä¢ Add send throttling using BOTH:
	‚Ä¢	MAX_EMAILS_PER_CYCLE (env)
	‚Ä¢	MAX_EMAILS_PER_HOUR (env)

‚Ä¢ Maintain an hourly counter (DB table or small JSON file).
‚Ä¢ If threshold reached ‚Üí skip sending for remainder of hour, log event.

‚Ä¢ Add structured log entries:
[EMAIL][<MODE>][<SUCCESS|FAIL>][lead=<id>][company=<company>]

‚Ä¢ If send fails:
	‚Ä¢	Never crash
	‚Ä¢	Return failure result to BizDev agent

	2.	BizDev agent integration:

‚Ä¢ Replace legacy logic with unified send_email()
‚Ä¢ Lead status rules:
	‚Ä¢	success ‚Üí CONTACTED
	‚Ä¢	fail ‚Üí EMAIL_FAILED
	‚Ä¢	dry_run ‚Üí leave status NEW

‚Ä¢ Save:
	‚Ä¢	last_contacted_at
	‚Ä¢	email subject + preview

	3.	Admin Console:

‚Ä¢ Show outbound mode indicator with color:
	‚Ä¢	DRY_RUN ‚Üí orange
	‚Ä¢	SENDGRID / SMTP ‚Üí green

‚Ä¢ Add Outbound Log table (last 20 entries):
	‚Ä¢	timestamp
	‚Ä¢	company
	‚Ä¢	email
	‚Ä¢	subject
	‚Ä¢	mode
	‚Ä¢	result

	4.	Documentation in replit.md:

‚Ä¢ All required env vars for SENDGRID/SMTP
‚Ä¢ Example Secrets config
‚Ä¢ Testing with /admin/send-test-email

============================================================
B) REAL LEAD SEARCH API INTEGRATION

Goal: Replace DummySeed when credentials exist.
	1.	In lead_sources.py:

‚Ä¢ Implement SearchApiLeadSourceProvider using:
	‚Ä¢	LEAD_SEARCH_API_URL
	‚Ä¢	LEAD_SEARCH_API_KEY
	‚Ä¢	LEAD_NICHE
	‚Ä¢	LEAD_GEOGRAPHY
	‚Ä¢	MAX_NEW_LEADS_PER_CYCLE

‚Ä¢ Safe request handling (GET or POST depending on provider)
‚Ä¢ DRY_RUN fallback if credentials missing
‚Ä¢ Extract:
	‚Ä¢	company
	‚Ä¢	contact name
	‚Ä¢	email
	‚Ä¢	website/domain
	‚Ä¢	industry

‚Ä¢ Idempotent dedupe:
	‚Ä¢	Skip inserting leads where email matches existing
	‚Ä¢	Skip inserting leads where (company, domain) matches existing
	‚Ä¢	Treat existing leads with status != ‚Äúinvalid‚Äù as authoritative

	2.	lead_service.py:

‚Ä¢ Provider selection using env LEAD_SOURCE_PROVIDER:
	‚Ä¢	DUMMY_SEED (default)
	‚Ä¢	SEARCH_API

‚Ä¢ Add source field to lead: ‚Äúdummy_seed‚Äù or ‚Äúsearch_api‚Äù

‚Ä¢ Log all new leads to lead_source_log.json
‚Ä¢ Cap log file to last 5,000 entries (prevent runaway disk usage)
	3.	Admin Console:

‚Ä¢ Show active provider
‚Ä¢ Show API configuration health
‚Ä¢ Show last run timestamp
‚Ä¢ Display errors if API misconfigured
	4.	Update replit.md:

‚Ä¢ Document full configuration for real Lead API provider

============================================================
C) NICHE-TUNED BIZDEV TEMPLATE ENGINE
	1.	Add bizdev_templates.py:

‚Ä¢ A dict of template packs keyed by niche (BIZDEV_NICHE_TEMPLATE)
‚Ä¢ Each pack contains:
	‚Ä¢	subject_lines: list[str]
	‚Ä¢	body_templates: list[str]

‚Ä¢ Templates use placeholders:
{{first_name}}, {{company_name}}, {{industry}}, {{offer}}, {{niche}}, {{sender_name}}, {{sender_email}}, {{dashboard_url}}
	2.	Add env var:
BIZDEV_NICHE_TEMPLATE=
	3.	In BizDev agent:

‚Ä¢ Load template pack based on env
‚Ä¢ Randomize subject + body template
‚Ä¢ Substitute placeholders
‚Ä¢ Truncate preview for logs
‚Ä¢ Log generated copy to email_log.json
‚Ä¢ Cap that log to last 5,000 entries
	4.	Admin Console:

‚Ä¢ Show active BizDev template pack
‚Ä¢ Show last ~10 generated templates (subject + snippet)
‚Ä¢ Display LEAD_NICHE + LEAD_GEOGRAPHY values in Lead Source panel
	5.	Update replit.md:

‚Ä¢ How to choose/add template packs

============================================================
D) STRIPE BILLING INTEGRATION (PAYMENT LINKS + WEBHOOK)
	1.	Add stripe_utils.py:

‚Ä¢ create_payment_link(amount_cents, customer_id, description)
‚Ä¢ create_draft_invoice(customer_id, line_items)
‚Ä¢ Validate Stripe credentials
‚Ä¢ Errors ‚Üí DRY fallback without crashing
	2.	Required env vars:
STRIPE_API_KEY
STRIPE_WEBHOOK_SECRET
STRIPE_DEFAULT_CURRENCY (default: usd)
ENABLE_STRIPE=TRUE/FALSE
	3.	Billing agent changes:

‚Ä¢ After local DB draft invoice creation:
If ENABLE_STRIPE == TRUE:
	‚Ä¢	Create Stripe payment link
	‚Ä¢	Save URL to invoice.payment_url

‚Ä¢ Add invoice amount safety clamp:
	‚Ä¢	Only allow $1‚Äì$500 by default
	‚Ä¢	Skip + log if outside bounds

	4.	Add /stripe/webhook route:

‚Ä¢ Validate signature
‚Ä¢ On payment event:
	‚Ä¢	invoice.status = paid
	‚Ä¢	invoice.paid_at = now

‚Ä¢ Log all webhook events
	5.	Admin Console:

‚Ä¢ Stripe indicator (Enabled/Disabled)
‚Ä¢ Show payment link inline
‚Ä¢ Show paid status updates
	6.	Update replit.md:

‚Ä¢ Full Stripe setup
‚Ä¢ How to expose webhook URL

============================================================
E) CUSTOMER PORTAL 2.0 (READ-ONLY)
	1.	Add new route:
/portal/<public_token>

Do NOT use raw DB IDs.
Use a stable public_token field added to Customer. Generate automatically if missing.

Portal must show:
‚Ä¢ Customer name
‚Ä¢ Recent tasks (status + summaries)
‚Ä¢ Outstanding invoices + payment links
‚Ä¢ Paid invoices
‚Ä¢ Basic revenue summary
	2.	Add templates/customer_portal.html:

‚Ä¢ Noir theme (Tailwind CDN)
‚Ä¢ Minimal, clean layout
‚Ä¢ Payment link buttons
‚Ä¢ Task summaries
	3.	Navigation rules:

‚Ä¢ Do NOT show portal link globally
‚Ä¢ Page accessible only by direct URL
	4.	DB updates:

‚Ä¢ Add public_token to Customer if missing
‚Ä¢ Add payment_url to Invoice
	5.	Update replit.md with instructions for customers

============================================================
F) DATABASE MIGRATIONS

Auto-create/update schema on startup.

Add/ensure fields exist:

Lead:
‚Ä¢ website
‚Ä¢ source

Invoice:
‚Ä¢ payment_url

Customer:
‚Ä¢ public_token

Add log files (JSON) with rotation/truncation:
‚Ä¢ email_log.json
‚Ä¢ lead_source_log.json

============================================================
G) IRON-CLAD SAFETY RULES
	1.	DRY_RUN must NEVER be bypassed if configuration is missing.
If SENDGRID, SMTP, Lead API, or Stripe credentials are missing or invalid, the system MUST:
	‚Ä¢	fall back silently to DRY_RUN
	‚Ä¢	never crash
	‚Ä¢	never attempt real sends/charges
	‚Ä¢	log [DRY_RUN_FALLBACK] <reason>
	2.	NEVER exceed MAX_EMAILS_PER_CYCLE or MAX_EMAILS_PER_HOUR.
Track hourly counts and skip sends when limits reached.
	3.	All failures MUST degrade gracefully without interrupting the autopilot loop.

============================================================
H) FINAL DELIVERABLES

When you finish:

‚Ä¢ List all files added/modified
‚Ä¢ List ALL required environment variables
‚Ä¢ Provide manual test steps for:
	‚Ä¢	Outbound email
	‚Ä¢	Lead API
	‚Ä¢	BizDev templates
	‚Ä¢	Stripe payments + webhook
	‚Ä¢	Customer portal
‚Ä¢ Provide summary of new behaviors

Begin now.

============================================================
END OF PROMPT

‚∏ª

If you want, I can also produce:

üî• A 10-minute full system smoke test
üî• A disaster-proof rollback plan
üî• A Phase 3 spec (‚ÄúHossAgent Hires More Hosses‚Äù)

Just say the word.